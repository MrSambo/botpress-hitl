{"version":3,"sources":["webpack:///webpack/bootstrap abf2706d1a3559ba5fdb","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///./src/db.js","webpack:///external \"bluebird\"","webpack:///external \"moment\"","webpack:///external \"lodash\"","webpack:///external \"botpress\"","webpack:///external \"path\"","webpack:///external \"fs\"","webpack:///external \"winston\""],"names":["winston","require","db","config","incomingMiddleware","event","next","includes","type","getUserSession","then","session","is_new_session","bp","events","emit","appendMessageToSession","id","message","paused","logger","debug","text","outgoingMiddleware","module","exports","sessionExpiry","default","env","init","configurator","__dirname","middlewares","register","name","order","handler","description","loadAll","get","knex","initialize","ready","hitl","pause","platform","userId","setSessionPaused","sessionId","unpause","isPaused","isSessionPaused","router","getRouter","req","res","getAllSessions","query","onlyPaused","send","sessions","getSessionData","params","messages","post","body","getSession","user","raw","to","sendOutgoing","sendStatus","Error","createTableIfNotExists","table","increments","primary","string","timestamp","boolean","integer","references","onDelete","jsonb","enu","createUserSession","profileUrl","full_name","Math","random","toString","substr","first_name","last_name","profile_pic","picture_url","user_image_url","last_event_on","date","now","last_heard_on","paused_trigger","insert","results","where","Object","assign","db_session","select","limit","users","length","toPlainObject","object","mapValues","v","sql","direction","session_id","raw_message","ts","update","trigger","parseInt","toBool","bool","parse","s","condition","true","from","groupBy","as","join","whereRaw","orderBy","total","k"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/Fatalic/Documents/Development/botpress-hitl\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap abf2706d1a3559ba5fdb","import checkVersion from 'botpress-version-manager'\nimport DB from './db'\nimport _ from 'lodash'\nimport path from 'path'\nimport fs from 'fs'\nvar winston = require('winston');\n\n// TODO: Cleanup old sessions\n// TODO: If messages count > X, delete some\n\nlet db = null\nlet config = null\n\nconst incomingMiddleware = (event, next) => {\n  if (!db) { return next() }\n\n  if (_.includes(['delivery', 'read'], event.type)) {\n    return next()\n  }\n\n  return db.getUserSession(event)\n  .then(session => {\n    if (session.is_new_session) {\n      event.bp.events.emit('hitl.session', session)\n    }\n\n    return db.appendMessageToSession(event, session.id, 'in')\n    .then(message => {\n      event.bp.events.emit('hitl.message', message)\n      if ((!!session.paused || config.paused) && _.includes(['text', 'message'], event.type)) {\n        event.bp.logger.debug('[hitl] Session paused, message swallowed:', event.text)\n        // the session or bot is paused, swallow the message\n        return\n      } else {\n        next()\n      }\n    })\n  })\n}\n\nconst outgoingMiddleware = (event, next) => {\n  if (!db) { return next() }\n\n  return db.getUserSession(event)\n  .then(session => {\n\n    if (session.is_new_session) {\n      event.bp.events.emit('hitl.session', session)\n    }\n\n    return db.appendMessageToSession(event, session.id, 'out')\n    .then(message => {\n      event.bp.events.emit('hitl.message', message)\n      next()\n    })\n  })\n}\n\nmodule.exports = {\n\n  config: {\n    sessionExpiry: { type: 'string', default: '3 days' },\n    paused: { type: 'bool', default: false, env: 'BOTPRESS_HITL_PAUSED' }\n  },\n\n  init: async (bp, configurator) => {\n    checkVersion(bp, __dirname)\n\n    bp.middlewares.register({\n      name: 'hitl.captureInMessages',\n      type: 'incoming',\n      order: 2,\n      handler: incomingMiddleware,\n      module: 'botpress-hitl',\n      description: 'Captures incoming messages and if the session if paused, swallow the event.'\n    })\n\n    bp.middlewares.register({\n      name: 'hitl.captureOutMessages',\n      type: 'outgoing',\n      order: 50,\n      handler: outgoingMiddleware,\n      module: 'botpress-hitl',\n      description: 'Captures outgoing messages to show inside HITL.'\n    })\n\n    config = await configurator.loadAll()\n\n    bp.db.get()\n    .then(knex => db = DB(knex))\n    .then(() => db.initialize())\n  },\n\n  ready: function(bp) {\n\n    bp.hitl = {\n      pause: (platform, userId) => {\n        return db.setSessionPaused(true, platform, userId, 'code')\n        .then(sessionId => {\n          event.bp.logger.debug('[hitl] Session paused, message swallowed:', event.text)\n\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 1 })\n        })\n      },\n      unpause: (platform, userId) => {\n        return db.setSessionPaused(false, platform, userId, 'code')\n        .then(sessionId => {\n          bp.events.emit('hitl.session', { id: sessionId })\n          bp.events.emit('hitl.session.changed', { id: sessionId, paused: 0 })\n        })\n      },\n      isPaused: (platform, userId) => {\n        return db.isSessionPaused(platform, userId)\n      }\n    }\n\n    const router = bp.getRouter('botpress-hitl')\n\n    router.get('/sessions', (req, res) => {\n      db.getAllSessions(req.query.onlyPaused === \"true\")\n      .then(sessions => res.send(sessions))\n    })\n\n    router.get('/sessions/:sessionId', (req, res) => {\n      db.getSessionData(req.params.sessionId)\n      .then(messages => res.send(messages))\n    })\n\n    router.post('/sessions/:sessionId/message', (req, res) => {\n      const { message } = req.body\n\n      db.getSession(req.params.sessionId)\n      .then(session => {\n        const event = {\n          type: 'text',\n          platform: session.platform,\n          user: {id: session.userId},\n          raw: { to: session.userId, message: message },\n          text: message\n        }\n\n        bp.middlewares.sendOutgoing(event)\n\n        res.sendStatus(200)\n      })\n    })\n\n    // TODO post /sessions/:id/typing\n    \n    router.post('/sessions/:sessionId/pause', (req, res) => {\n      db.setSessionPaused(true, null, null, 'operator', req.params.sessionId)\n      .then(sessionId => {\n        bp.events.emit('hitl.session', { id: sessionId })\n        bp.events.emit('hitl.session.changed', { id: sessionId, paused: 1 })\n      })\n      .then(res.sendStatus(200))\n    })\n\n    router.post('/sessions/:sessionId/unpause', (req, res) => {\n      db.setSessionPaused(false, null, null, 'operator', req.params.sessionId)\n      .then(sessionId => {\n        bp.events.emit('hitl.session', { id: sessionId })\n        bp.events.emit('hitl.session.changed', { id: sessionId, paused: 0 })\n      })\n      .then(res.sendStatus(200))\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 2\n// module chunks = 0","import Promise from 'bluebird'\nimport moment from 'moment'\nimport _ from 'lodash'\nimport { DatabaseHelpers as helpers } from 'botpress'\n\nvar knex = null\n\nfunction initialize() {\n  if (!knex) {\n    throw new Error('you must initialize the database before')\n  }\n\n  return helpers(knex).createTableIfNotExists('hitl_sessions', function (table) {\n    table.increments('id').primary()\n    table.string('platform')\n    table.string('userId')\n    table.string('full_name')\n    table.string('user_image_url')\n    table.timestamp('last_event_on')\n    table.timestamp('last_heard_on')\n    table.boolean('paused')\n    table.string('paused_trigger')\n  })\n  .then(function() {\n    return helpers(knex).createTableIfNotExists('hitl_messages', function (table) {\n      table.increments('id').primary()\n      table.integer('session_id').references('hitl_sessions.id').onDelete('CASCADE')\n      table.string('type')\n      table.string('text')\n      table.jsonb('raw_message')\n      table.enu('direction', ['in', 'out'])\n      table.timestamp('ts')\n    })\n  })\n}\n\nfunction createUserSession(event) {\n  let profileUrl = null\n  let full_name = '#' + Math.random().toString().substr(2)\n\n  if (event.user && event.user.first_name && event.user.last_name) {\n    profileUrl = event.user.profile_pic || event.user.picture_url\n    full_name = event.user.first_name + ' ' + event.user.last_name\n  }\n\n  const session = { \n    platform: event.platform,\n    userId: event.user.id,\n    user_image_url: profileUrl,\n    last_event_on: helpers(knex).date.now(),\n    last_heard_on: helpers(knex).date.now(),\n    paused: 0,\n    full_name: full_name,\n    paused_trigger: null\n  }\n\n  return knex('hitl_sessions')\n  .insert(session)\n  .then(results => { \n    session.id = results[0]\n    session.is_new_session = true\n  })\n  .then(() => knex('hitl_sessions').where({ id: session.id }).then().get(0))\n  .then(db_session => Object.assign({}, session, db_session))\n}\n\nfunction getUserSession(event) {\n  const userId = (event.user && event.user.id) || event.raw.to\n  return knex('hitl_sessions')\n  .where({ platform: event.platform, userId: userId })\n  .select('*')\n  .limit(1)\n  .then(users => {\n    if (!users || users.length === 0) {\n      return createUserSession(event)\n    } else {\n      return users[0]\n    }\n  })\n}\n\nfunction getSession(sessionId) {\n  return knex('hitl_sessions')\n  .where({ id: sessionId })\n  .select('*')\n  .limit(1)\n  .then(users => {\n    if (!users || users.length === 0) {\n      return null\n    } else {\n      return users[0]\n    }\n  })\n}\n\nfunction toPlainObject(object) {\n  // trims SQL queries from objects\n  return _.mapValues(object, v => {\n    return v.sql ? v.sql : v\n  })\n}\n\nfunction appendMessageToSession(event, sessionId, direction) {\n\n  let message = {\n    session_id: sessionId,\n    type: event.type,\n    text: event.text,\n    raw_message: event.raw,\n    direction: direction,\n    ts: helpers(knex).date.now()\n  }\n\n  const update = { last_event_on: helpers(knex).date.now() }\n\n  if (direction === 'in') {\n    update.last_heard_on = helpers(knex).date.now()\n  }\n\n  return knex('hitl_messages')\n  .insert(message)\n  .then(() => {\n    return knex('hitl_sessions')\n    .where({ id: sessionId })\n    .update(update)\n    .then(() => toPlainObject(message))\n  })\n}\n\nfunction setSessionPaused(paused, platform, userId, trigger, sessionId = null) {\n  if (sessionId) {\n    return knex('hitl_sessions')\n    .where({ id: sessionId })\n    .update({ paused: paused ? 1 : 0, paused_trigger: trigger })\n    .then(() => parseInt(sessionId))\n  } else {\n    return knex('hitl_sessions')\n    .where({ userId, platform })\n    .update({ paused: paused ? 1 : 0, paused_trigger: trigger })\n    .then(() => {\n      return knex('hitl_sessions')\n      .where({ userId, platform })\n      .select('id')\n    })\n    .then(sessions => parseInt(sessions[0].id))\n  }\n}\n\nfunction isSessionPaused(platform, userId, sessionId = null) {\n  const toBool = s => helpers(knex).bool.parse(s)\n\n  if (sessionId) {\n    return knex('hitl_sessions')\n    .where({ id: sessionId })\n    .select('paused').then().get(0).then(s => s && toBool(s.paused))\n  } else {\n    return knex('hitl_sessions')\n    .where({ userId, platform })\n    .select('paused').then().get(0).then(s => s && toBool(s.paused))\n  }\n}\n\nfunction getAllSessions(onlyPaused) {\n  let condition = ''\n\n  if (onlyPaused === true) {\n    condition = 'hitl_sessions.paused = ' + helpers(knex).bool.true()\n  }\n\n  return knex.select('*').from(function() {\n    this.select([knex.raw('max(id) as mId'), 'session_id', knex.raw('count(*) as count')])\n    .from('hitl_messages')\n    .groupBy('session_id')\n    .as('q1')\n  })\n  .join('hitl_messages', knex.raw('q1.mId'), 'hitl_messages.id')\n  .join('hitl_sessions', knex.raw('q1.session_id'), 'hitl_sessions.id')\n  .whereRaw(condition)\n  .orderBy('hitl_sessions.last_event_on', 'desc')\n  .limit(100)\n  .then(results => ({\n    total: 0,\n    sessions: results\n  }))\n}\n\nfunction getSessionData(sessionId) {\n  return knex('hitl_sessions')\n  .where({ 'session_id': sessionId })\n  .join('hitl_messages', 'hitl_messages.session_id', 'hitl_sessions.id')\n  .orderBy('hitl_messages.id', 'desc')\n  .limit(100)\n  .select('*')\n  .then(messages => _.orderBy(messages, ['id'], ['asc']))\n}\n\nmodule.exports = k => {\n  knex = k\n\n  return {\n    initialize,\n    getUserSession,\n    setSessionPaused,\n    appendMessageToSession,\n    getAllSessions,\n    getSessionData,\n    getSession,\n    isSessionPaused\n  }\n}\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"winston\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"winston\"\n// module id = 10\n// module chunks = 0"],"sourceRoot":""}